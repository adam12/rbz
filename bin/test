#!/usr/bin/env bash
set -e

echo "Testing rbz compression and execution..."

dest=$(mktemp)

echo "Testing example_1..."
ruby -Ilib exe/rbz examples/example_1 > $dest
chmod +x $dest
output1=$(ruby $dest)
expected1="Hello world"
if [ "$output1" = "$expected1" ]; then
  echo "✅ example_1 test passed: '$output1'"
else
  echo "❌ example_1 test failed: expected '$expected1', got '$output1'"
  exit 1
fi

# Test example_2 directory
echo "Testing example_2..."
ruby -Ilib exe/rbz examples/example_2 > $dest
chmod +x $dest
output2=$(ruby $dest)
expected2="Hello from other file"
if [ "$output2" = "$expected2" ]; then
  echo "✅ example_2 test passed: '$output2'"
else
  echo "❌ example_2 test failed: expected '$expected2', got '$output2'"
  exit 1
fi

echo "Testing examples/bundled..."
ruby -Ilib exe/rbz examples/bundled > $dest
chmod +x $dest
ruby $dest
if [ $? -eq 0 ]; then
  echo "✅ examples/bundled test passed"
else
  echo "❌ examples/bundled test failed"
  exit 1
fi

echo "All tests passed! 🎉"

# Clean up generated files
rm -f "$dest"
